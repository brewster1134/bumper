// Generated by CoffeeScript 1.9.0

/*
 * * bumper | responsive | image
 * * https://github.com/brewster1134/bumper
 * *
 * * @author Ryan Brewster
 * * Copyright (c) 2014
 * * Licensed under the MIT license.
 */

(function() {
  var __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    __hasProp = {}.hasOwnProperty;

  (function(root, factory) {
    if (typeof define === 'function' && define.amd) {
      return define(['bumper-core', 'bumper-responsive-breakpoint'], function() {
        return factory();
      });
    } else if (typeof exports !== 'undefined') {
      return module.exports = factory();
    } else {
      return factory();
    }
  })(this, function() {
    var BumperResponsiveImage, _base, _base1;
    BumperResponsiveImage = (function(_super) {
      __extends(BumperResponsiveImage, _super);

      function BumperResponsiveImage() {
        return BumperResponsiveImage.__super__.constructor.apply(this, arguments);
      }

      BumperResponsiveImage.prototype.events = function() {
        var responsiveObserver;
        window.addEventListener('load', (function(_this) {
          return function() {
            return _this.resizeAll();
          };
        })(this));
        window.addEventListener('bumper-responsive-breakpoint-change', (function(_this) {
          return function() {
            return _this.resizeAll();
          };
        })(this));
        responsiveObserver = new MutationObserver((function(_this) {
          return function() {
            return _this.resizeAll();
          };
        })(this));
        responsiveObserver.observe(document, {
          childList: true,
          subtree: true
        });
        return this;
      };

      BumperResponsiveImage.prototype.resizeAll = function() {
        var image, images, _i, _len;
        images = document.querySelectorAll('.bumper-responsive-image');
        for (_i = 0, _len = images.length; _i < _len; _i++) {
          image = images[_i];
          this.resize(image);
        }
        return images;
      };

      BumperResponsiveImage.prototype.resize = function(el, breakpoint, force) {
        var fullUrl, img, _ref, _ref1;
        if (force == null) {
          force = false;
        }
        if (el.jquery) {
          el = el[0];
        }
        breakpoint || (breakpoint = (_ref = window.Bumper.Responsive.Breakpoint) != null ? _ref.getCurrent() : void 0);
        fullUrl = this.getUrl(el, breakpoint);
        if (!fullUrl) {
          return false;
        }
        if (force === false && (((_ref1 = el.getAttribute('src')) != null ? _ref1.indexOf(fullUrl) : void 0) >= 0 || el.style.backgroundImage.indexOf(fullUrl) >= 0)) {
          return fullUrl;
        }
        if (el.tagName === 'IMG') {
          img = el;
          img.addEventListener('load', function() {
            var event;
            event = new CustomEvent('bumper-responsive-image-loaded', {
              detail: {
                img: img
              }
            });
            return img.dispatchEvent(event);
          });
          img.setAttribute('data-bumper-breakpoint', breakpoint);
          img.setAttribute('src', fullUrl);
        } else {
          img = document.createElement('img');
          img.addEventListener('load', function() {
            var event, src;
            src = this.getAttribute('src');
            el.setAttribute('data-bumper-breakpoint', breakpoint);
            el.style.backgroundImage = "url(" + src + ")";
            event = new CustomEvent('bumper-responsive-image-loaded', {
              detail: {
                img: img
              }
            });
            return el.dispatchEvent(event);
          });
          img.setAttribute('src', fullUrl);
        }
        return fullUrl;
      };

      BumperResponsiveImage.prototype.getUrl = function(el, breakpoint) {
        var fullUrl, params, url, _ref;
        if (breakpoint == null) {
          breakpoint = 'default';
        }
        url = el.getAttribute("data-bumper-responsive-image-url-" + breakpoint) || el.getAttribute('data-bumper-responsive-image-url');
        params = el.getAttribute("data-bumper-responsive-image-url-params-" + breakpoint) || el.getAttribute('data-bumper-responsive-image-url-params');
        if (!url) {
          throw new Error("data-bumper-responsive-image-url[-" + breakpoint + "] is not set.");
        }
        fullUrl = params ? url + "?" + params : url;
        fullUrl = ((_ref = window.Bumper.Dom) != null ? _ref.getElementData(fullUrl, el) : void 0) || fullUrl;
        return fullUrl;
      };

      return BumperResponsiveImage;

    })(window.Bumper.Core.Module);
    window.Bumper || (window.Bumper = {});
    (_base = window.Bumper).Responsive || (_base.Responsive = {});
    return (_base1 = window.Bumper.Responsive).Image || (_base1.Image = new BumperResponsiveImage);
  });

}).call(this);
